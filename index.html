<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOUPA // POLYGON_PROTOCOL_v10</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@100;400;700&family=Inter:wght@200;400;900&display=swap" rel="stylesheet">

    <style>
        /* LOUPA ARCHITECTURAL CORE v10.4.2 
           "THE POLYGON UPDATE"
        */
        :root {
            --bg: #020202;
            --surface: #0a0a0a;
            --elevated: #151515;
            --accent: #ff5500;
            --accent-soft: rgba(255, 85, 0, 0.2);
            --text-main: #ffffff;
            --text-dim: #888888;
            --success: #00ffaa;
            --error: #ff2222;
            --border: rgba(255, 255, 255, 0.08);
            --font-mono: 'JetBrains Mono', monospace;
            --ease: cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* --- BASIC RESET --- */
        * { box-sizing: border-box; margin: 0; padding: 0; cursor: none !important; }
        html, body { 
            background: var(--bg); color: var(--text-main); 
            font-family: 'Inter', sans-serif; overflow-x: hidden;
            width: 100%; min-height: 100vh;
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); }

        /* --- GEOMETRIC BACKGROUND ENGINE --- */
        #geo-canvas { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .overlay-scan {
            position: fixed; inset: 0; z-index: 1000; pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; opacity: 0.15;
        }
        .vignette { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle, transparent 30%, #000 110%); }

        /* --- NAVIGATION --- */
        nav {
            position: fixed; top: 0; width: 100%; height: 100px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%; z-index: 2000; transition: 0.6s var(--ease);
            border-bottom: 1px solid var(--border); backdrop-filter: blur(20px);
        }
        nav.scrolled { height: 70px; background: rgba(0,0,0,0.9); }
        .brand { font-family: 'Space Grotesk'; font-size: 2rem; font-weight: 700; letter-spacing: -2px; }
        .brand span { color: var(--accent); }

        .nav-links { display: flex; gap: 40px; }
        .nav-link { 
            font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-dim); 
            text-decoration: none; transition: 0.3s; letter-spacing: 2px;
        }
        .nav-link:hover, .nav-link.active { color: var(--accent); }

        /* --- UI COMPONENTS --- */
        .btn {
            background: transparent; border: 1px solid var(--border); color: #fff;
            padding: 16px 35px; font-family: var(--font-mono); font-size: 0.7rem;
            text-transform: uppercase; transition: 0.5s var(--ease);
            position: relative; overflow: hidden; display: inline-flex; align-items: center; gap: 10px;
        }
        .btn:hover { background: #fff; color: #000; transform: translateY(-5px); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 700; }

        .container { width: 90%; max-width: 1500px; margin: 0 auto; }
        
        /* --- HERO --- */
        .hero { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; }
        .hero h1 { font-size: clamp(4rem, 15vw, 11rem); line-height: 0.8; font-family: 'Space Grotesk'; font-weight: 900; margin-bottom: 40px; }
        .hero p { max-width: 600px; color: var(--text-dim); font-size: 1.2rem; line-height: 1.8; margin-bottom: 50px; border-left: 2px solid var(--accent); padding-left: 30px; }

        /* --- SERVICE CARDS --- */
        .matrix { padding: 150px 0; }
        .matrix-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); 
            gap: 25px; margin-top: 80px; 
        }
        .card {
            background: var(--surface); border: 1px solid var(--border);
            padding: 60px; transition: 0.7s var(--ease);
            display: flex; flex-direction: column; justify-content: space-between; min-height: 550px;
        }
        .card:hover { border-color: var(--accent); transform: scale(1.02); background: var(--elevated); }
        .card h3 { font-family: 'Space Grotesk'; font-size: 2.2rem; margin: 20px 0; }
        .card p { color: var(--text-dim); line-height: 1.6; }
        .price { font-family: 'Space Grotesk'; font-size: 3rem; font-weight: 900; margin: 40px 0; }
        .price.ez { color: var(--success); }

        /* --- DASHBOARD --- */
        .order-box {
            background: var(--surface); border: 1px solid var(--border);
            padding: 40px; margin-bottom: 20px; display: flex; 
            justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
        }
        .license { font-family: var(--font-mono); font-size: 0.65rem; color: var(--accent); background: #000; padding: 10px; border: 1px dashed #333; }

        /* --- ADMIN ROOT --- */
        #root-panel {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            padding: 5%; overflow-y: auto; display: none;
        }
        .stat-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin: 50px 0; }
        .stat-card { background: var(--surface); padding: 40px; border-bottom: 4px solid var(--accent); }
        .stat-card div { font-size: 3rem; font-family: 'Space Grotesk'; font-weight: 700; color: #fff; }

        /* --- CUSTOM CURSOR --- */
        #cursor-dot { position: fixed; width: 6px; height: 6px; background: #fff; border-radius: 50%; pointer-events: none; z-index: 10001; }
        #cursor-ring { 
            position: fixed; width: 50px; height: 50px; border: 1px solid var(--accent); 
            border-radius: 50%; pointer-events: none; z-index: 10000;
            transition: width 0.4s, height 0.4s, transform 0.15s;
        }

        /* --- NOTIFICATIONS --- */
        #toast-bin { position: fixed; top: 120px; right: 40px; z-index: 4000; display: flex; flex-direction: column; gap: 15px; }
        .toast {
            background: #111; border-left: 4px solid var(--accent);
            padding: 25px 40px; color: #fff; font-family: var(--font-mono); font-size: 0.75rem;
            animation: slideIn 0.5s var(--ease) forwards;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- ANIMATIONS --- */
        .reveal { opacity: 0; transform: translateY(60px); transition: 1.5s var(--ease); }
        .reveal.active { opacity: 1; transform: translateY(0); }

        @media (max-width: 768px) {
            .nav-links { display: none; }
            .hero h1 { font-size: 4rem; }
            .matrix-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <canvas id="geo-canvas"></canvas>
    <div class="overlay-scan"></div>
    <div class="vignette"></div>
    <div id="cursor-dot"></div>
    <div id="cursor-ring"></div>
    <div id="toast-bin"></div>

    <div id="auth-gate" style="position:fixed; inset:0; background:var(--bg); z-index:9000; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
        <div class="reveal active">
            <div class="mono" style="color:var(--accent); margin-bottom:20px;">SYSTEM_INITIALIZING_V10</div>
            <h1 class="brand" style="font-size: 6rem; margin-bottom: 20px;">LOUPA<span>.</span></h1>
            <p style="color:var(--text-dim); margin-bottom:50px;">AUTHENTICATE TO ACCESS PROTOCOL</p>
            <button onclick="Loupa.auth.enter()" class="btn btn-primary">Connect Identity</button>
        </div>
    </div>

    <nav id="navbar">
        <a href="#" class="brand">LOUPA<span>.</span></a>
        <div class="nav-links">
            <a href="#services" class="nav-link">SERVICES</a>
            <a href="#dashboard" class="nav-link">DASHBOARD</a>
            <a href="#legal" class="nav-link">INTEL</a>
        </div>
        <div style="display:flex; align-items:center; gap:20px;">
            <div id="status-light" style="width:10px; height:10px; background:var(--success); border-radius:50%; box-shadow: 0 0 10px var(--success);"></div>
            <div id="user-name" class="mono" style="font-size:0.65rem; color:var(--text-dim);">GUEST_MODE</div>
        </div>
    </nav>

    <main id="app-root" style="display:none; margin-top:100px;">
        
        <section class="container hero">
            <div class="reveal">
                <div class="mono" style="color:var(--accent); margin-bottom:20px;">// CORE_ALGORITHM_LOADED</div>
                <h1>DEVELOPING<br><span id="type-target" style="color:var(--accent);"></span></h1>
                <p>Loupa is a premium digital agency providing high-performance assets for modern startups. From minimalist logos to complex neural interfaces.</p>
                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <button onclick="window.scrollTo(0, 1100)" class="btn btn-primary">Explore Matrix</button>
                    <button class="btn" onclick="Loupa.ui.toast('Accessing archive logs...')">Project History</button>
                </div>
            </div>
        </section>

        <section class="container matrix" id="services">
            <div class="reveal">
                <div class="mono" style="color:var(--accent); margin-bottom:20px;">01 // SERVICE_CATALOG</div>
                <h2 style="font-size: 4rem; font-family:'Space Grotesk';">Asset_Deployments</h2>
                
                <div style="display:flex; gap:15px; margin-top:40px; flex-wrap:wrap;">
                    <button onclick="Loupa.logic.filter('ALL')" class="btn" style="padding:10px 20px; font-size:0.6rem;">SHOW_ALL</button>
                    <button onclick="Loupa.logic.filter('EZ')" class="btn" style="padding:10px 20px; font-size:0.6rem; border-color:var(--success)">EZ_BUDGET</button>
                    <button onclick="Loupa.logic.filter('PRO')" class="btn" style="padding:10px 20px; font-size:0.6rem; border-color:var(--accent)">ENTERPRISE</button>
                </div>
            </div>

            <div class="matrix-grid" id="service-target">
                </div>
        </section>

        <section class="container" id="dashboard" style="padding: 150px 0; border-top:1px solid var(--border);">
            <div class="reveal">
                <div class="mono" style="color:var(--accent); margin-bottom:20px;">02 // CLIENT_STORAGE</div>
                <h2 style="font-size: 3.5rem; font-family:'Space Grotesk';">Personal_Archive</h2>
            </div>
            
            <div id="order-root" class="reveal" style="margin-top:60px;">
                <div class="order-box mono" style="justify-content:center; color:var(--text-dim);">
                    SYNCHRONIZING_WITH_CLOUD...
                </div>
            </div>
        </section>

        <footer style="padding: 100px 0 50px; border-top: 1px solid var(--border);">
            <div class="container" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:40px;">
                <div class="brand">LOUPA<span>.</span></div>
                <div class="mono" style="color:var(--text-dim); font-size:0.6rem;">&copy; 2026 LOUPA // LICENSED_DIGITAL_FOUNDRY</div>
                <div class="mono" id="clock">00:00:00</div>
            </div>
        </footer>
    </main>

    <div id="root-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="font-family:'Space Grotesk'; color:var(--accent); font-size:3rem;">ROOT_OBSERVER</h2>
            <button onclick="Loupa.admin.toggle()" class="btn">DISCONNECT</button>
        </div>
        <div class="stat-row">
            <div class="stat-card"><small>TOTAL_EQUITY</small><div id="adm-rev">$0</div></div>
            <div class="stat-card"><small>CONNECTED_PEERS</small><div id="adm-users">0</div></div>
            <div class="stat-card"><small>ACTIVE_BUILDS</small><div id="adm-orders">0</div></div>
            <div class="stat-card"><small>SERVER_LOAD</small><div>12%</div></div>
        </div>
        <div style="background:var(--surface); padding:50px; border:1px solid var(--border);">
            <h3 class="mono" style="margin-bottom:40px;">USER_LOG_HISTORY</h3>
            <table style="width:100%; border-collapse:collapse; font-family:var(--font-mono); font-size:0.75rem; text-align:left;">
                <thead style="color:var(--text-dim); border-bottom:1px solid var(--border);">
                    <tr><th style="padding:20px;">CLIENT</th><th>EMAIL</th><th>IP_ADDR</th><th>RANK</th></tr>
                </thead>
                <tbody id="adm-table"></tbody>
            </table>
        </div>
    </div>

    <div id="checkout-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.98); z-index:10000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(30px);">
        <div style="background:var(--surface); border:1px solid var(--accent); width:95%; max-width:600px; padding:70px; text-align:center;">
            <h2 id="m-name" style="font-family:'Space Grotesk'; font-size:3rem; margin-bottom:15px;">SERVICE</h2>
            <div class="mono" id="m-id" style="color:var(--accent); margin-bottom:30px;">ID: 000</div>
            <p id="m-desc" style="color:var(--text-dim); line-height:1.8; margin-bottom:50px;"></p>
            <div id="paypal-inject"></div>
            <button onclick="Loupa.ui.closeModal()" class="btn" style="width:100%; margin-top:30px;">TERMINATE_SESSION</button>
        </div>
    </div>

    <script>
    "use strict";

    const Loupa = (() => {

        const ADMIN_MAIL = "wahdkhonafdar@gmail.com";
        const firebaseConfig = {
            apiKey: "AIzaSyDwkqu_JpelnceEjwbdP76hzwQ1JMFI2D0",
            authDomain: "loupa-d2ca2.firebaseapp.com",
            projectId: "loupa-d2ca2",
            storageBucket: "loupa-d2ca2.firebasestorage.app",
            messagingSenderId: "1062889452519",
            appId: "1:1062889452519:web:a412e262ba0981d3c3c342"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // MASTER SERVICE REGISTRY (15+ ITEMS)
        const services = [
            { id: "EZ-1", name: "Favicon Kit", price: 15, cat: "EZ", desc: "Complete browser and mobile icon generation." },
            { id: "EZ-2", name: "Minimal Logo", price: 25, cat: "EZ", desc: "High-precision vector identity for startups." },
            { id: "EZ-3", name: "Script Fix", price: 30, cat: "EZ", desc: "Bug resolution for React/JS/Python logic." },
            { id: "EZ-4", name: "SEO Scan", price: 20, cat: "EZ", desc: "Full performance audit and visibility report." },
            { id: "EZ-5", name: "HTML Email", price: 45, cat: "EZ", desc: "Responsive template for CRM marketing." },
            { id: "PRO-1", name: "SaaS OS", price: 499, cat: "PRO", desc: "Complete custom landing and marketing suite." },
            { id: "PRO-2", name: "Data Bot", price: 550, cat: "PRO", desc: "Autonomous web scraper with CSV/JSON export." },
            { id: "PRO-3", name: "Firebase Core", price: 850, cat: "PRO", desc: "Database architecture and Auth integration." },
            { id: "PRO-4", name: "Neural AI", price: 1200, cat: "PRO", desc: "Bespoke LLM integration for custom datasets." },
            { id: "PRO-5", name: "DDoS Shield", price: 700, cat: "PRO", desc: "Domain hardening and firewall optimization." },
            { id: "PRO-6", name: "React App", price: 950, cat: "PRO", desc: "Functional frontend prototype with API link." },
            { id: "PRO-7", name: "Discord OS", price: 400, cat: "PRO", desc: "Advanced server management and bot logic." },
            { id: "PRO-8", name: "Rank Surge", price: 600, cat: "PRO", desc: "Intensive 30-day technical SEO overhaul." },
            { id: "PRO-9", name: "Web3 Contract", price: 1800, cat: "PRO", desc: "Audited smart contract on ETH or Polygon." },
            { id: "PRO-10", name: "Consult Session", price: 150, cat: "PRO", desc: "1-hour deep architecture and strategy call." }
        ];

        // --- BACKGROUND ENGINE (POLYGONS & SQUARES) ---
        const VisualEngine = {
            canvas: null, ctx: null, pts: [], sqs: [], mouse: {x:0, y:0},
            
            init() {
                this.canvas = document.getElementById('geo-canvas');
                this.ctx = this.canvas.getContext('2d');
                window.onresize = () => this.resize(); this.resize();
                
                for(let i=0; i<80; i++) this.pts.push({
                    x: Math.random() * this.canvas.width, y: Math.random() * this.canvas.height,
                    vx: (Math.random()-0.5)*0.8, vy: (Math.random()-0.5)*0.8,
                    ox: 0, oy: 0
                });

                for(let i=0; i<15; i++) this.sqs.push({
                    x: Math.random() * this.canvas.width, y: Math.random() * this.canvas.height,
                    s: Math.random() * 50 + 20, r: Math.random() * Math.PI,
                    v: Math.random() * 0.01
                });

                document.addEventListener('mousemove', e => {
                    this.mouse.x = e.clientX; this.mouse.y = e.clientY;
                });
                this.loop();
            },
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },
            loop() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // DRAW DATA SQUARES
                this.sqs.forEach(s => {
                    s.r += s.v;
                    this.ctx.save();
                    this.ctx.translate(s.x, s.y);
                    this.ctx.rotate(s.r);
                    this.ctx.strokeStyle = 'rgba(255, 85, 0, 0.05)';
                    this.ctx.strokeRect(-s.s/2, -s.s/2, s.s, s.s);
                    this.ctx.restore();
                });

                // DRAW POLYGON MESH
                this.pts.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy;
                    if(p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
                    if(p.y < 0 || p.y > this.canvas.height) p.vy *= -1;

                    const dx = this.mouse.x - p.x;
                    const dy = this.mouse.y - p.y;
                    const d = Math.sqrt(dx*dx + dy*dy);
                    if(d < 300) {
                        p.ox = dx * 0.05; p.oy = dy * 0.05;
                    } else {
                        p.ox *= 0.95; p.oy *= 0.95;
                    }

                    this.ctx.fillStyle = 'rgba(255, 85, 0, 0.5)';
                    this.ctx.beginPath();
                    this.ctx.arc(p.x + p.ox, p.y + p.oy, 1, 0, Math.PI*2);
                    this.ctx.fill();

                    for(let j=i+1; j < this.pts.length; j++) {
                        const p2 = this.pts[j];
                        const d2 = Math.hypot((p.x+p.ox)-(p2.x+p2.ox), (p.y+p.oy)-(p2.y+p2.oy));
                        if(d2 < 160) {
                            this.ctx.strokeStyle = `rgba(255, 85, 0, ${0.15 * (1 - d2/160)})`;
                            this.ctx.lineWidth = 0.5;
                            this.ctx.beginPath();
                            this.ctx.moveTo(p.x+p.ox, p.y+p.oy);
                            this.ctx.lineTo(p2.x+p2.ox, p2.y+p2.oy);
                            this.ctx.stroke();
                        }
                    }
                });
                requestAnimationFrame(() => this.loop());
            }
        };

        // --- LOGIC: AUTH ---
        const AuthModule = {
            async enter() {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const res = await auth.signInWithPopup(provider);
                    const ipReq = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipReq.json();
                    
                    await db.collection("users").doc(res.user.uid).set({
                        name: res.user.displayName,
                        email: res.user.email,
                        ip: ipData.ip,
                        rank: res.user.email === ADMIN_MAIL ? 'ROOT' : 'CLIENT',
                        ts: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    UIModule.toast("HANDSHAKE_COMPLETE");
                } catch(e) { UIModule.toast("ACCESS_DENIED", "error"); }
            },
            listen() {
                auth.onAuthStateChanged(u => {
                    const gate = document.getElementById('auth-gate');
                    const app = document.getElementById('app-root');
                    if(u) {
                        gate.style.display = 'none'; app.style.display = 'block';
                        document.getElementById('user-name').innerText = u.displayName.split(' ')[0].toUpperCase();
                        OrderModule.sync(u.uid);
                    } else {
                        gate.style.display = 'flex'; app.style.display = 'none';
                    }
                });
            }
        };

        // --- LOGIC: UI ---
        const UIModule = {
            filter: 'ALL',
            init() {
                this.type(); this.cursor(); this.clock(); this.reveal(); this.render();
                window.onscroll = () => {
                    const n = document.getElementById('navbar');
                    if(window.scrollY > 80) n.classList.add('scrolled');
                    else n.classList.remove('scrolled');
                };
            },
            render() {
                const target = document.getElementById('service-target');
                const data = this.filter === 'ALL' ? services : services.filter(s => s.cat === this.filter);
                target.innerHTML = data.map((s, idx) => `
                    <div class="card reveal active">
                        <div>
                            <div class="mono" style="color:var(--accent); font-size:0.6rem;">NODE_0${idx+1} // ${s.cat}</div>
                            <h3>${s.name}</h3>
                            <p>${s.desc}</p>
                        </div>
                        <div>
                            <div class="price ${s.cat === 'EZ' ? 'ez' : ''}">$${s.price}</div>
                            <button onclick="Loupa.ui.openModal('${s.id}')" class="btn ${s.cat === 'PRO' ? 'btn-primary' : ''}" style="width:100%">DEPLOY_PROTOCOL</button>
                        </div>
                    </div>
                `).join('');
            },
            type() {
                const words = ["IDENTITIES.", "PROTOCOLS.", "ALGORITHMS."];
                let wI = 0, cI = 0, del = false;
                const t = document.getElementById('type-target');
                const loop = () => {
                    const cur = words[wI];
                    t.innerText = del ? cur.substring(0, cI--) : cur.substring(0, cI++);
                    if(!del && cI > cur.length) { del = true; setTimeout(loop, 2000); }
                    else if(del && cI === 0) { del = false; wI = (wI+1)%words.length; setTimeout(loop, 500); }
                    else setTimeout(loop, del ? 50 : 130);
                };
                loop();
            },
            cursor() {
                const d = document.getElementById('cursor-dot');
                const r = document.getElementById('cursor-ring');
                document.onmousemove = e => {
                    d.style.left = e.clientX + 'px'; d.style.top = e.clientY + 'px';
                    r.style.left = (e.clientX - 25) + 'px'; r.style.top = (e.clientY - 25) + 'px';
                };
                document.querySelectorAll('button, a, .card').forEach(el => {
                    el.onmouseenter = () => { r.style.width = '75px'; r.style.height = '75px'; r.style.borderColor = '#fff'; };
                    el.onmouseleave = () => { r.style.width = '50px'; r.style.height = '50px'; r.style.borderColor = 'var(--accent)'; };
                });
            },
            toast(m, t = 'success') {
                const bin = document.getElementById('toast-bin');
                const div = document.createElement('div');
                div.className = 'toast';
                if(t === 'error') div.style.borderLeftColor = 'var(--error)';
                div.innerHTML = `<span class="mono">LOG: ${m}</span>`;
                bin.appendChild(div);
                setTimeout(() => div.remove(), 4000);
            },
            openModal(id) {
                const s = services.find(x => x.id === id);
                document.getElementById('m-name').innerText = s.name.toUpperCase();
                document.getElementById('m-id').innerText = `ASSET_REF: ${s.id}`;
                document.getElementById('m-desc').innerText = s.desc;
                document.getElementById('checkout-modal').style.display = 'flex';
                document.getElementById('paypal-inject').innerHTML = '';
                paypal.Buttons({
                    createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: s.price } }] }),
                    onApprove: (d, a) => a.order.capture().then(() => OrderModule.save(s))
                }).render('#paypal-inject');
            },
            closeModal() { document.getElementById('checkout-modal').style.display = 'none'; },
            clock() { setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour12:false}); }, 1000); },
            reveal() {
                const obs = new IntersectionObserver(ents => { ents.forEach(e => { if(e.isIntersecting) e.target.classList.add('active'); }); }, {threshold: 0.1});
                document.querySelectorAll('.reveal').forEach(el => obs.observe(el));
            }
        };

        // --- LOGIC: ORDERS ---
        const OrderModule = {
            async save(s) {
                const u = auth.currentUser;
                const key = 'LPX-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                await db.collection("orders").add({
                    uid: u.uid, name: u.displayName, mail: u.email,
                    item: s.name, cost: s.price, key: key,
                    status: 'PENDING_BUILD', ts: firebase.firestore.FieldValue.serverTimestamp()
                });
                UIModule.closeModal();
                UIModule.toast("DEPOLYMENT_KEY_GENERATED");
            },
            sync(uid) {
                db.collection("orders").where("uid", "==", uid).onSnapshot(snap => {
                    const root = document.getElementById('order-root');
                    if(snap.empty) { root.innerHTML = `<div class="order-box mono" style="justify-content:center;">ZERO_ACTIVE_CHANNELS</div>`; return; }
                    root.innerHTML = snap.docs.map(doc => {
                        const d = doc.data();
                        return `
                            <div class="order-box">
                                <div>
                                    <div class="mono" style="color:var(--accent); font-size:0.6rem;">REF: ${doc.id.substring(0,8)}</div>
                                    <h4 style="font-family:'Space Grotesk'; font-size:1.5rem; margin:8px 0;">${d.item}</h4>
                                    <div class="license">LICENSE_KEY: ${d.key}</div>
                                </div>
                                <div class="mono" style="color:var(--success)">[${d.status}]</div>
                                <div class="price ez" style="font-size:1.8rem; margin:0;">$${d.cost}</div>
                            </div>
                        `;
                    }).join('');
                });
            }
        };

        // --- LOGIC: ADMIN ---
        const AdminModule = {
            toggle() {
                const p = document.getElementById('root-panel');
                p.style.display = p.style.display === 'block' ? 'none' : 'block';
                if(p.style.display === 'block') this.load();
            },
            load() {
                db.collection("users").onSnapshot(snap => {
                    document.getElementById('adm-users').innerText = snap.size;
                    document.getElementById('adm-table').innerHTML = snap.docs.map(doc => {
                        const u = doc.data();
                        return `<tr style="border-bottom:1px solid #111;"><td style="padding:20px; color:#fff;">${u.name}</td><td>${u.email}</td><td>${u.ip}</td><td style="color:var(--accent)">${u.rank}</td></tr>`;
                    }).join('');
                });
                db.collection("orders").onSnapshot(snap => {
                    let total = 0; snap.forEach(d => total += d.data().cost);
                    document.getElementById('adm-rev').innerText = `$${total}`;
                    document.getElementById('adm-orders').innerText = snap.size;
                });
            }
        };

        return { 
            auth: AuthModule, 
            ui: UIModule, 
            admin: AdminModule,
            logic: { filter: c => { UIModule.filter = c; UIModule.render(); UIModule.toast(`FILTER: ${c}`); } },
            engine: VisualEngine
        };

    })();

    // INITALIZE
    window.onload = () => {
        Loupa.engine.init();
        Loupa.auth.listen();
        Loupa.ui.init();
    };

    window.onkeydown = e => {
        if(e.shiftKey && e.key === 'A' && firebase.auth().currentUser?.email === "wahdkhonafdar@gmail.com") Loupa.admin.toggle();
        if(e.key === 'Escape') Loupa.ui.closeModal();
    };
    </script>
</body>
</html>
