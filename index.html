<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOUPA // CORE_ENGINE_V8</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@100;400;700&family=Inter:wght@200;400;900&display=swap" rel="stylesheet">

    <style>
        /* LOUPA DIGITAL FOUNDRY - DESIGN SYSTEM v8.0
           "The Obsidian Protocol"
        */
        :root {
            --bg: #010101;
            --surface: #080808;
            --elevated: #121212;
            --accent: #ff5500;
            --accent-glow: rgba(255, 85, 0, 0.3);
            --text-main: #f5f5f5;
            --text-dim: #666666;
            --success: #00ff88;
            --error: #ff3333;
            --border: rgba(255, 255, 255, 0.08);
            --ease: cubic-bezier(0.16, 1, 0.3, 1);
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* --- CORE RESET & SCROLL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; selection-background: var(--accent); }
        html, body { 
            background: var(--bg); color: var(--text-main); 
            font-family: 'Inter', sans-serif; overflow-x: hidden;
            width: 100%; min-height: 100vh;
        }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--accent); }

        /* --- VISUAL ENGINE LAYERS --- */
        #vortex-canvas { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .scanline {
            position: fixed; inset: 0; z-index: 1000; pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%; opacity: 0.1;
        }
        .vignette { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle, transparent 20%, #000 100%); opacity: 0.8; }

        /* --- NAVIGATION --- */
        nav {
            position: fixed; top: 0; width: 100%; height: 90px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%; z-index: 900; backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .brand { font-family: 'Space Grotesk'; font-size: 1.5rem; font-weight: 700; text-transform: uppercase; letter-spacing: -1px; }
        .brand span { color: var(--accent); }
        
        .nav-links { display: flex; gap: 40px; }
        .nav-link { 
            font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-dim); 
            text-decoration: none; transition: 0.3s; letter-spacing: 1px;
        }
        .nav-link:hover, .nav-link.active { color: #fff; }

        /* --- BUTTON PRIMITIVES --- */
        .btn {
            background: transparent; border: 1px solid var(--border); color: #fff;
            padding: 14px 28px; font-family: var(--font-mono); font-size: 0.7rem;
            text-transform: uppercase; cursor: none; transition: var(--ease);
            position: relative; overflow: hidden; display: inline-flex; align-items: center; gap: 10px;
        }
        .btn:hover { background: #fff; color: #000; border-color: #fff; transform: translateY(-3px); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 700; }

        /* --- HERO SECTION --- */
        .container { width: 90%; max-width: 1440px; margin: 0 auto; }
        .hero { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .hero h1 { font-size: clamp(3.5rem, 12vw, 9rem); line-height: 0.85; font-family: 'Space Grotesk'; font-weight: 700; margin-bottom: 2rem; }
        .hero p { max-width: 600px; color: var(--text-dim); font-size: 1.2rem; line-height: 1.6; border-left: 2px solid var(--accent); padding-left: 30px; }

        /* --- SERVICE MATRIX --- */
        .matrix-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 20px; margin: 100px 0; 
        }
        .card {
            background: var(--surface); border: 1px solid var(--border);
            padding: 50px; position: relative; transition: 0.6s var(--ease);
            display: flex; flex-direction: column; justify-content: space-between; min-height: 450px;
        }
        .card:hover { border-color: var(--accent); background: var(--elevated); transform: translateY(-15px); }
        .card h3 { font-family: 'Space Grotesk'; font-size: 2rem; margin: 20px 0; }
        .card p { color: var(--text-dim); font-size: 0.9rem; line-height: 1.6; }
        .price-tag { font-family: 'Space Grotesk'; font-size: 2.5rem; font-weight: 700; margin: 30px 0; }
        .price-tag.ez { color: var(--success); }

        /* --- COMMAND CENTER (DASHBOARD) --- */
        .dashboard { padding: 150px 0; background: #030303; border-top: 1px solid var(--border); }
        .order-item {
            background: var(--surface); border: 1px solid var(--border);
            padding: 30px; margin-bottom: 20px; display: flex; 
            justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
        }
        .license-key { 
            font-family: var(--font-mono); font-size: 0.6rem; background: #000; 
            padding: 10px; border: 1px dashed var(--text-dim); color: var(--accent);
        }

        /* --- ADMIN ROOT OVERLAY --- */
        #admin-panel {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            padding: 5%; overflow-y: auto; display: none;
        }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 40px 0; }
        .stat-box { background: var(--surface); padding: 30px; border-bottom: 3px solid var(--accent); }
        .stat-box small { color: var(--text-dim); font-family: var(--font-mono); font-size: 0.6rem; }
        .stat-box .val { font-size: 2.5rem; font-family: 'Space Grotesk'; font-weight: 700; color: var(--accent); }

        /* --- TERMINAL --- */
        #l-term {
            position: fixed; bottom: 30px; left: 30px; width: 450px; height: 320px;
            background: rgba(2, 2, 2, 0.98); border: 1px solid var(--border);
            z-index: 800; display: flex; flex-direction: column; transition: 0.5s var(--ease);
        }
        #l-term.minimized { transform: translateY(calc(100% - 40px)); }
        .term-header { background: #111; padding: 10px 15px; display: flex; justify-content: space-between; cursor: pointer; }
        .term-body { flex: 1; padding: 20px; overflow-y: auto; font-family: var(--font-mono); font-size: 0.75rem; color: var(--success); }
        .term-input-line { display: flex; padding: 10px 15px; background: #000; border-top: 1px solid var(--border); }
        .term-input { background: transparent; border: none; color: #fff; flex: 1; margin-left: 10px; font-family: inherit; }

        /* --- AUTH & NOTIFICATIONS --- */
        #gatekeeper {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        #notifier { position: fixed; top: 110px; right: 30px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--elevated); border-left: 4px solid var(--accent);
            padding: 20px 30px; color: #fff; font-family: var(--font-mono); font-size: 0.7rem;
            min-width: 300px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            animation: toastIn 0.4s var(--ease);
        }
        @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- CUSTOM CURSOR --- */
        #c-dot { position: fixed; width: 5px; height: 5px; background: #fff; border-radius: 50%; pointer-events: none; z-index: 10001; }
        #c-ring { 
            position: fixed; width: 40px; height: 40px; border: 1px solid var(--accent); 
            border-radius: 50%; pointer-events: none; z-index: 10000;
            transition: width 0.3s, height 0.3s, border-color 0.3s;
        }

        /* --- ANIMATIONS --- */
        .reveal { opacity: 0; transform: translateY(40px); transition: 1.2s var(--ease); }
        .reveal.active { opacity: 1; transform: translateY(0); }

        /* --- MOBILE RESPONSIVENESS (BREAKPOINTS) --- */
        @media (max-width: 1024px) {
            .hero h1 { font-size: 5.5rem; }
            .matrix-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            nav { height: 70px; }
            .nav-links { display: none; }
            .hero h1 { font-size: 3.8rem; }
            .matrix-grid { grid-template-columns: 1fr; }
            #l-term { width: calc(100% - 40px); left: 20px; }
            .card { padding: 30px; min-height: 380px; }
            .btn { padding: 12px 20px; width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <canvas id="vortex-canvas"></canvas>
    <div class="scanline"></div>
    <div class="vignette"></div>
    <div id="c-dot"></div>
    <div id="c-ring"></div>
    <div id="notifier"></div>

    <div id="gatekeeper">
        <div class="reveal active">
            <div class="mono" style="color:var(--accent); margin-bottom:1rem;">SYSTEM_ACCESS_v.8.0</div>
            <h1 class="brand" style="font-size: 5rem;">LOUPA<span>.</span></h1>
            <p style="color:var(--text-dim); margin-bottom:3rem;">ESTABLISH SECURE LINK TO PROCEED</p>
            <button onclick="Loupa.auth.initiate()" class="btn btn-primary">Link Identity</button>
        </div>
    </div>

    <nav id="nav-main">
        <a href="#" class="brand">LOUPA<span>.</span></a>
        <div class="nav-links">
            <a href="#services" class="nav-link active">CAPABILITIES</a>
            <a href="#dashboard" class="nav-link">DASHBOARD</a>
            <a href="#reputation" class="nav-link">REPUTATION</a>
        </div>
        <div style="display:flex; align-items:center; gap:20px;">
            <div class="mono" id="user-display" style="color:var(--text-dim); font-size:0.6rem;">UNAUTHORIZED</div>
            <div id="admin-light" style="display:none; width:8px; height:8px; background:var(--accent); border-radius:50%; box-shadow:0 0 10px var(--accent);"></div>
        </div>
    </nav>

    <main id="app-root" style="display:none; margin-top:90px;">
        
        <section class="container hero">
            <div class="reveal">
                <div class="mono" style="color:var(--accent); margin-bottom:1rem;">[ ARCHITECTING THE FUTURE ]</div>
                <h1>CRAFTING<br><span id="type-target" style="color:var(--accent);"></span></h1>
                <p>Loupa is a high-performance digital foundry. We specialize in autonomous web systems, high-frequency interfaces, and bespoke cloud infrastructure.</p>
                <div style="display:flex; gap:20px; margin-top:3rem; flex-wrap:wrap;">
                    <button onclick="window.scrollTo(0, 1100)" class="btn btn-primary">Initialize Protocol</button>
                    <button class="btn" onclick="Loupa.terminal.log('Accessing server archives...')">View Archive</button>
                </div>
            </div>
        </section>

        <section class="container" id="services" style="padding: 100px 0;">
            <div class="reveal">
                <div class="mono" style="color:var(--accent); margin-bottom:1rem;">// CAPABILITY_MATRIX</div>
                <h2 style="font-size: 3.5rem; font-family: 'Space Grotesk';">Service_Tiering</h2>
                
                <div style="display:flex; gap:10px; margin-top:2rem; flex-wrap:wrap;">
                    <button onclick="Loupa.services.filter('ALL')" class="btn" style="padding:8px 15px; font-size:0.6rem;">ALL_ASSETS</button>
                    <button onclick="Loupa.services.filter('EZ')" class="btn" style="padding:8px 15px; font-size:0.6rem; border-color:var(--success)">BUDGET_WINS</button>
                    <button onclick="Loupa.services.filter('ELITE')" class="btn" style="padding:8px 15px; font-size:0.6rem; border-color:var(--accent)">ENTERPRISE</button>
                </div>
            </div>

            <div class="matrix-grid" id="service-target">
                </div>
        </section>

        <section class="dashboard" id="dashboard">
            <div class="container">
                <div class="reveal">
                    <div class="mono" style="color:var(--accent); margin-bottom:1rem;">// PROJECT_STATUS</div>
                    <h2 style="font-size: 3rem; font-family: 'Space Grotesk';">Client_Vault</h2>
                </div>
                
                <div id="user-order-root" class="reveal" style="margin-top:4rem;">
                    <div class="order-item mono" style="justify-content:center; color:var(--text-dim);">
                        SCANNING_BLOCKCHAIN_FOR_PURCHASES...
                    </div>
                </div>
            </div>
        </section>

        <section class="container" id="reputation" style="padding: 150px 0;">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 100px; align-items:center;">
                <div class="reveal">
                    <h2 style="font-size: 3rem; font-family: 'Space Grotesk';">Global_Trust</h2>
                    <p style="margin-top:2rem;">Our systems manage over $4M in digital liquidity. We operate with a 99.99% uptime guarantee and sub-10ms latency targets.</p>
                </div>
                <div class="reveal" style="background:var(--surface); padding:50px; border:1px solid var(--border);">
                    <div class="mono" style="color:var(--accent); margin-bottom:1rem;">DIRECT_TRANSMISSION</div>
                    <p style="font-style:italic; font-size:1.1rem; line-height:1.8;">"The automation loops Loupa built reduced our server overhead by 40% in week one. Total game changer."</p>
                    <div class="mono" style="margin-top:2rem; font-size:0.6rem;">- CEO, ASTRA_CORE</div>
                </div>
            </div>
        </section>

        <footer style="padding: 100px 0 50px; border-top:1px solid var(--border);">
            <div class="container" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:30px;">
                <div class="brand">LOUPA<span>.</span></div>
                <div class="mono" style="color:var(--text-dim); font-size:0.6rem;">&copy; 2026 LOUPA // ENCRYPTED_SITES_OS</div>
                <div class="mono" id="sys-clock">00:00:00</div>
            </div>
        </footer>
    </main>

    <div id="l-term" class="minimized">
        <div class="term-header" onclick="Loupa.terminal.toggle()">
            <span class="mono" style="font-size:0.6rem;">LOUPA_CORE_CONSOLE</span>
            <span class="mono" id="term-stat">[+]</span>
        </div>
        <div class="term-body" id="term-out">
            Establishing connection to Loupa Central... Done.<br>
            Type 'help' to see command list.
        </div>
        <div class="term-input-line">
            <span class="mono" style="color:var(--accent)">></span>
            <input type="text" id="term-in" class="term-input" autocomplete="off" placeholder="cmd...">
        </div>
    </div>

    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="font-family: 'Space Grotesk'; color:var(--accent);">ROOT_ACCESS_LEVEL_0</h2>
            <button onclick="Loupa.admin.toggle()" class="btn">EXIT_ROOT</button>
        </div>
        <div class="stat-grid">
            <div class="stat-box"><small>TOTAL_LIQUIDITY</small><div class="val" id="a-rev">$0</div></div>
            <div class="stat-box"><small>CONNECTED_PEERS</small><div class="val" id="a-users">0</div></div>
            <div class="stat-box"><small>ACTIVE_BUILDS</small><div class="val" id="a-orders">0</div></div>
            <div class="stat-box"><small>DB_LATENCY</small><div class="val">14ms</div></div>
        </div>
        <div style="background:var(--surface); padding:40px; border:1px solid var(--border);">
            <h3 class="mono" style="margin-bottom:2rem;">CLIENT_DATABASE</h3>
            <table style="width:100%; border-collapse:collapse; font-family:var(--font-mono); font-size:0.7rem;">
                <thead style="text-align:left; color:var(--text-dim); border-bottom:1px solid var(--border);">
                    <tr><th style="padding:15px;">USER</th><th>EMAIL</th><th>IP_ORIGIN</th><th>STATUS</th></tr>
                </thead>
                <tbody id="a-table"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-checkout" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:15000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(20px);">
        <div style="background:var(--surface); border:1px solid var(--accent); width:90%; max-width:550px; padding:60px; text-align:center; position:relative;">
            <h2 id="m-name" style="font-family:'Space Grotesk'; font-size:2.5rem; margin-bottom:10px;">NAME</h2>
            <div class="mono" id="m-id" style="color:var(--accent); margin-bottom:2rem;">ID: 000</div>
            <p id="m-desc" style="color:var(--text-dim); line-height:1.6;"></p>
            <div id="paypal-inject" style="margin-top:3rem;"></div>
            <button onclick="Loupa.ui.closeModal()" class="btn" style="width:100%; margin-top:20px;">ABORT_PROTOCOL</button>
        </div>
    </div>

    <script>
    "use strict";

    const Loupa = (() => {

        // --- INTERNAL CONFIG ---
        const ADMIN_EMAIL = "wahdkhonafdar@gmail.com";
        const firebaseConfig = {
            apiKey: "AIzaSyDwkqu_JpelnceEjwbdP76hzwQ1JMFI2D0",
            authDomain: "loupa-d2ca2.firebaseapp.com",
            projectId: "loupa-d2ca2",
            storageBucket: "loupa-d2ca2.firebasestorage.app",
            messagingSenderId: "1062889452519",
            appId: "1:1062889452519:web:a412e262ba0981d3c3c342"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- SERVICE ARCHIVE (15 ITEMS) ---
        const serviceRegistry = [
            { id: "EZ-1", name: "Minimalist Logo", price: 15, cat: "EZ", desc: "Clean vector brand identity. 24h delivery." },
            { id: "EZ-2", name: "CSS Refactor", price: 25, cat: "EZ", desc: "Quick layout bug fixes and modern styling." },
            { id: "EZ-3", name: "Site Audit", price: 20, cat: "EZ", desc: "Performance & SEO deep-dive report." },
            { id: "EZ-4", name: "Asset Pack", price: 15, cat: "EZ", desc: "High-res icons and favicon set for all devices." },
            { id: "EZ-5", name: "Email Template", price: 45, cat: "EZ", desc: "Responsive HTML marketing newsletter." },
            { id: "PRO-1", name: "SaaS Landing", price: 350, cat: "ELITE", desc: "High-conversion one-pager for software." },
            { id: "PRO-2", name: "Python Scraper", price: 400, cat: "ELITE", desc: "Autonomous data extraction engine." },
            { id: "PRO-3", name: "Cloud Firestore", price: 800, cat: "ELITE", desc: "Scalable backend architecture setup." },
            { id: "PRO-4", name: "Neural Chatbot", price: 950, cat: "ELITE", desc: "Custom LLM integration for customer support." },
            { id: "PRO-5", name: "Discord Automator", price: 300, cat: "ELITE", desc: "Advanced server management bot logic." },
            { id: "PRO-6", name: "Smart Contract", price: 1200, cat: "ELITE", desc: "Ethereum/Solidity contract development." },
            { id: "PRO-7", name: "App Prototype", price: 600, cat: "ELITE", desc: "Interactive Figma to React foundation build." },
            { id: "PRO-8", name: "SEO Dominance", price: 500, cat: "ELITE", desc: "Full-scale technical ranking overhaul." },
            { id: "PRO-9", name: "Security Shield", price: 700, cat: "ELITE", desc: "DDoS protection and firewall hardening." },
            { id: "PRO-10", name: "Strategy Call", price: 100, cat: "ELITE", desc: "1-hour deep dive into your product roadmap." }
        ];

        // --- MODULE: AUTHENTICATION ---
        const AuthModule = {
            async initiate() {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const res = await auth.signInWithPopup(provider);
                    const ipRes = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipRes.json();
                    
                    await db.collection("users").doc(res.user.uid).set({
                        name: res.user.displayName,
                        email: res.user.email,
                        ip: ipData.ip,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                        rank: res.user.email === ADMIN_EMAIL ? 'ROOT' : 'USER'
                    }, { merge: true });

                    UIModule.toast("LINK_STABLISHED: WELCOME " + res.user.displayName.toUpperCase());
                } catch (e) {
                    UIModule.toast("AUTH_FAILURE: " + e.message, "error");
                }
            },

            listen() {
                auth.onAuthStateChanged(user => {
                    if(user) {
                        document.getElementById('gatekeeper').style.display = 'none';
                        document.getElementById('app-root').style.display = 'block';
                        document.getElementById('user-display').innerText = user.displayName.split(' ')[0].toUpperCase();
                        if(user.email === ADMIN_EMAIL) document.getElementById('admin-light').style.display = 'block';
                        OrderModule.sync(user.uid);
                    } else {
                        document.getElementById('gatekeeper').style.display = 'flex';
                        document.getElementById('app-root').style.display = 'none';
                    }
                });
            }
        };

        // --- MODULE: UI & ANIMATION ENGINE ---
        const UIModule = {
            currentFilter: 'ALL',

            init() {
                this.startVortex();
                this.startClock();
                this.typewriter();
                this.bindCursor();
                this.initReveal();
                this.renderServices();
            },

            renderServices() {
                const target = document.getElementById('service-target');
                const data = this.currentFilter === 'ALL' 
                    ? serviceRegistry 
                    : serviceRegistry.filter(s => s.cat === this.currentFilter);

                target.innerHTML = data.map((s, idx) => `
                    <div class="card reveal active">
                        <div>
                            <div class="mono" style="color:var(--accent); font-size:0.6rem;">0${idx+1} // ${s.id}</div>
                            <h3>${s.name}</h3>
                            <p>${s.desc}</p>
                        </div>
                        <div>
                            <div class="price-tag ${s.cat === 'EZ' ? 'ez' : ''}">$${s.price}</div>
                            <button onclick="Loupa.ui.openModal('${s.id}')" class="btn ${s.cat === 'ELITE' ? 'btn-primary' : ''}" style="width:100%">
                                ${s.cat === 'EZ' ? 'QUICK_DEPLOY' : 'INITIATE_PROJECT'}
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            startVortex() {
                const canvas = document.getElementById('vortex-canvas');
                const ctx = canvas.getContext('2d');
                let pts = [];
                const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
                window.onresize = resize; resize();

                class Particle {
                    constructor() {
                        this.x = Math.random() * canvas.width;
                        this.y = Math.random() * canvas.height;
                        this.vx = (Math.random() - 0.5) * 0.4;
                        this.vy = (Math.random() - 0.5) * 0.4;
                    }
                    update() {
                        this.x += this.vx; this.y += this.vy;
                        if(this.x < 0 || this.x > canvas.width) this.vx *= -1;
                        if(this.y < 0 || this.y > canvas.height) this.vy *= -1;
                    }
                }
                for(let i=0; i<120; i++) pts.push(new Particle());

                const draw = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    pts.forEach(p => {
                        p.update();
                        ctx.fillStyle = 'rgba(255, 85, 0, 0.4)';
                        ctx.beginPath(); ctx.arc(p.x, p.y, 1, 0, Math.PI*2); ctx.fill();
                        pts.forEach(p2 => {
                            const d = Math.hypot(p.x - p2.x, p.y - p2.y);
                            if(d < 120) {
                                ctx.strokeStyle = `rgba(255, 85, 0, ${0.15 * (1 - d/120)})`;
                                ctx.lineWidth = 0.5;
                                ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
                            }
                        });
                    });
                    requestAnimationFrame(draw);
                };
                draw();
            },

            typewriter() {
                const words = ["THAT SCALE.", "THAT CONVERT.", "THAT THINK."];
                let wI = 0, cI = 0, del = false;
                const target = document.getElementById('type-target');
                const loop = () => {
                    const cur = words[wI];
                    target.innerText = del ? cur.substring(0, cI--) : cur.substring(0, cI++);
                    if(!del && cI > cur.length) { del = true; setTimeout(loop, 2000); }
                    else if(del && cI === 0) { del = false; wI = (wI+1)%words.length; setTimeout(loop, 500); }
                    else setTimeout(loop, del ? 50 : 120);
                };
                loop();
            },

            bindCursor() {
                const dot = document.getElementById('c-dot');
                const ring = document.getElementById('c-ring');
                document.addEventListener('mousemove', e => {
                    dot.style.left = e.clientX + 'px'; dot.style.top = e.clientY + 'px';
                    ring.style.left = (e.clientX - 20) + 'px'; ring.style.top = (e.clientY - 20) + 'px';
                });
                document.querySelectorAll('button, a, .card').forEach(el => {
                    el.onmouseenter = () => { ring.style.width = '60px'; ring.style.height = '60px'; ring.style.borderColor = '#fff'; };
                    el.onmouseleave = () => { ring.style.width = '40px'; ring.style.height = '40px'; ring.style.borderColor = 'var(--accent)'; };
                });
            },

            toast(msg, type = 'success') {
                const bin = document.getElementById('notifier');
                const t = document.createElement('div');
                t.className = 'toast';
                if(type === 'error') t.style.borderLeftColor = 'var(--error)';
                t.innerHTML = `<span class="mono">[SYS]: ${msg}</span>`;
                bin.appendChild(t);
                setTimeout(() => t.remove(), 5000);
            },

            openModal(id) {
                const s = serviceRegistry.find(x => x.id === id);
                document.getElementById('m-name').innerText = s.name.toUpperCase();
                document.getElementById('m-id').innerText = `ASSET_ID: ${s.id}`;
                document.getElementById('m-desc').innerText = s.desc;
                document.getElementById('modal-checkout').style.display = 'flex';
                
                document.getElementById('paypal-inject').innerHTML = '';
                paypal.Buttons({
                    createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: s.price } }] }),
                    onApprove: (d, a) => a.order.capture().then(() => OrderModule.create(s))
                }).render('#paypal-inject');
            },

            closeModal() { document.getElementById('modal-checkout').style.display = 'none'; },
            
            toggleTerm() {
                const t = document.getElementById('l-term');
                t.classList.toggle('minimized');
                document.getElementById('term-stat').innerText = t.classList.contains('minimized') ? '[+]' : '[-]';
            },

            startClock() {
                setInterval(() => {
                    document.getElementById('sys-clock').innerText = new Date().toLocaleTimeString('en-US', { hour12: false });
                }, 1000);
            },

            initReveal() {
                const obs = new IntersectionObserver(ents => {
                    ents.forEach(e => { if(e.isIntersecting) e.target.classList.add('active'); });
                }, { threshold: 0.1 });
                document.querySelectorAll('.reveal').forEach(el => obs.observe(el));
            }
        };

        // --- MODULE: ORDER MANAGEMENT ---
        const OrderModule = {
            async create(service) {
                const u = auth.currentUser;
                const key = 'LP-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                
                await db.collection("orders").add({
                    uid: u.uid,
                    client: u.displayName,
                    email: u.email,
                    service: service.name,
                    price: service.price,
                    license: key,
                    status: 'INITIALIZING',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                UIModule.closeModal();
                UIModule.toast("DEPLOYMENT_SUCCESS: LICENSE_KEY_GENERATED");
            },

            sync(uid) {
                db.collection("orders").where("uid", "==", uid).onSnapshot(snap => {
                    const target = document.getElementById('user-order-root');
                    if(snap.empty) {
                        target.innerHTML = `<div class="order-item mono" style="justify-content:center;">ZERO_ACTIVE_PROTOCOLS</div>`;
                        return;
                    }
                    target.innerHTML = snap.docs.map(doc => {
                        const d = doc.data();
                        return `
                            <div class="order-item">
                                <div>
                                    <div class="mono" style="color:var(--accent); font-size:0.6rem;">REQ_ID: ${doc.id.substring(0,8)}</div>
                                    <h4 style="font-family:'Space Grotesk'; font-size:1.2rem; margin:5px 0;">${d.service}</h4>
                                    <div class="license-key">KEY: ${d.license}</div>
                                </div>
                                <div class="mono" style="color:var(--success)">[${d.status}]</div>
                                <div class="price-tag ez" style="font-size:1.2rem; margin:0;">$${d.price}</div>
                            </div>
                        `;
                    }).join('');
                });
            }
        };

        // --- MODULE: ADMIN DASHBOARD ---
        const AdminModule = {
            toggle() {
                const p = document.getElementById('admin-panel');
                p.style.display = p.style.display === 'block' ? 'none' : 'block';
                if(p.style.display === 'block') this.refresh();
            },

            refresh() {
                db.collection("users").onSnapshot(snap => {
                    document.getElementById('a-users').innerText = snap.size;
                    const table = document.getElementById('a-table');
                    table.innerHTML = snap.docs.map(doc => {
                        const u = doc.data();
                        return `<tr style="border-bottom:1px solid #111;"><td style="padding:15px; color:#fff;">${u.name}</td><td>${u.email}</td><td>${u.ip}</td><td style="color:var(--success)">ACTIVE</td></tr>`;
                    }).join('');
                });

                db.collection("orders").onSnapshot(snap => {
                    let total = 0;
                    snap.forEach(d => total += d.data().price);
                    document.getElementById('a-rev').innerText = `$${total}`;
                    document.getElementById('a-orders').innerText = snap.size;
                });
            }
        };

        // --- MODULE: TERMINAL EMULATOR ---
        const TerminalModule = {
            log(msg) {
                const out = document.getElementById('term-out');
                const l = document.createElement('div');
                l.innerHTML = `<span style="color:var(--text-dim)">[${new Date().toLocaleTimeString()}]</span> > ${msg}`;
                out.appendChild(l);
                out.scrollTop = out.scrollHeight;
            },

            init() {
                const input = document.getElementById('term-in');
                input.addEventListener('keydown', e => {
                    if(e.key === 'Enter') {
                        const cmd = input.value.trim().toLowerCase();
                        this.execute(cmd);
                        input.value = '';
                    }
                });
            },

            execute(cmd) {
                this.log(cmd);
                if(cmd === 'help') {
                    this.log("Available: status, clear, sysinfo, contact, root");
                } else if(cmd === 'status') {
                    this.log("Vortex Core: Operational. Firewalls: Active.");
                } else if(cmd === 'clear') {
                    document.getElementById('term-out').innerHTML = '';
                } else if(cmd === 'root') {
                    if(auth.currentUser.email === ADMIN_EMAIL) {
                        this.log("Root authorized. Use Shift+A to toggle portal.");
                        AdminModule.toggle();
                    } else {
                        this.log("Permission denied. IP logged.");
                    }
                } else {
                    this.log("Command not found. Type 'help'.");
                }
            }
        };

        // GLOBAL KEY LISTENERS
        window.addEventListener('keydown', e => {
            if(e.shiftKey && e.key === 'A' && auth.currentUser.email === ADMIN_EMAIL) AdminModule.toggle();
            if(e.key === 'Escape') UIModule.closeModal();
        });

        // SERVICE FILTERING WRAPPER
        const ServiceModule = {
            filter(cat) {
                UIModule.currentFilter = cat;
                UIModule.renderServices();
                UIModule.toast(`FILTER_APPLIED: ${cat}`);
            }
        };

        return { 
            auth: AuthModule, 
            ui: UIModule, 
            terminal: TerminalModule, 
            admin: AdminModule,
            services: ServiceModule
        };

    })();

    // SYSTEM INITIALIZATION
    window.onload = () => {
        Loupa.auth.listen();
        Loupa.ui.init();
        Loupa.terminal.init();
    };
    </script>
</body>
</html>
